// Generated by CoffeeScript 1.12.2
(function() {
  var $;

  $ = jQuery.noConflict();

  $(function() {
    var age, asin, categories, close, details, info, pubDate, pubDateRaw, publisher, rank, ratingAvg, ratingCount, rawRank, removeBtn, tier;
    if (!/Amazon Best Sellers Rank/.test($('body').text())) {
      return;
    }
    details = {};
    categories = $();
    $('#productDetailsTable .content > ul > li').each(function() {
      var el, key, val;
      key = $(this).find('b:eq(0)').text().replace(/:$/, '').trim();
      el = $(this).clone();
      el.find('b:eq(0)').remove();
      val = el.text().trim();
      details[key] = val;
      if (key = 'Amazon Best Sellers Rank') {
        return categories = el.find('ul.zg_hrsr');
      }
    });
    asin = details['ASIN'];
    rawRank = details['Amazon Best Sellers Rank'].match(/(#[\d,]+)/)[1];
    rank = Number(rawRank != null ? rawRank.replace(/[,#]/g, '') : void 0);
    tier = rank < 10 ? '1' : rank < 100 ? '2' : rank < 1000 ? 'III' : rank < 10000 ? 'IV' : rank < 100000 ? 'V' : 'VI';
    ratingAvg = Number($('#summaryStars a.product-reviews-link').attr('title').match(/([\d\.]+)/)[1]);
    ratingCount = Number($('#acrCustomerReviewText').text().match(/([\d\.]+)/)[1]);
    publisher = details['Publisher'] ? details['Publisher'].replace(/;.*/, '') : details['Sold by'];
    pubDateRaw = details['Publication Date'] || details['Publisher'].match(/\((.*)\)/)[1];
    pubDate = moment(pubDateRaw, 'MMMM D, YYYY');
    age = moment.duration(moment().diff(pubDate));
    info = $('<div id="amazon-product-info-ext"/>');
    info.appendTo('header');
    info.append([
      "<b>" + ($('#title').text()) + "</b>", '<br/>', 'Publisher: ', (function() {
        if (/Amazon\s+Digital\s+Services\s+LLC/.test(publisher)) {
          return '<span class=hi>Self-Published</span>';
        } else {
          return publisher;
        }
      })(), ' - ', 'Author: ', $('.author .contributorNameID').clone().attr({
        target: '_blank'
      }), details['Print Length'] ? " - Length: " + details['Print Length'] : void 0, details['File Size'] ? " - Size: " + details['File Size'] : void 0, '<br/>', 'Rank: ', rawRank, ' - ', 'Tier ', tier, ' - ', "<a href='https://www.novelrank.com/asin/" + asin + "'>NovelRank</a>", ' - ', 'Rating: ', ratingAvg, ' - ', 'Reviews: ', ratingCount, ' - ', 'Age: ', (Math.round(age.asWeeks())) + " weeks", ' - ', 'Ratio: ', Number(ratingCount / age.asWeeks()).toFixed(2), '<br/>', categories
    ]);
    close = $('<div/>');
    close.css({
      position: 'absolute',
      top: '10px',
      right: '10px'
    });
    close.appendTo(info);
    removeBtn = $('<a href="#">X</a>');
    removeBtn.css({
      textDecoration: 'none'
    });
    removeBtn.on('click', function(e) {
      info.hide();
      return e.preventDefault();
    });
    return removeBtn.appendTo(close);
  });

}).call(this);
