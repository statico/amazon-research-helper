// Generated by CoffeeScript 1.12.2
(function() {
  var $;

  $ = jQuery.noConflict();

  $(function() {
    var age, asin, author, categories, close, d, fileSize, info, length, num, pubDate, pubDateRaw, publisher, rank, ratingAvg, ratingCount, removeBtn, tier, words;
    if (!/Amazon Best(s| S)ellers Rank/.test($('body').text())) {
      return;
    }
    num = function(str) {
      var m, ref;
      m = str != null ? (ref = str.match(/(\d+[\d\.,]*)/)) != null ? ref[1] : void 0 : void 0;
      m = m != null ? typeof m.replace === "function" ? m.replace(/,/g, '') : void 0 : void 0;
      return Number(m);
    };
    d = {};
    categories = $();
    $('#productDetailsTable, #detail_bullets_id').find('.content > ul > li').each(function() {
      var el, key, val;
      key = $(this).find('b:eq(0)').text().replace(/:$/, '').trim();
      el = $(this).clone();
      el.find('b:eq(0)').remove();
      val = el.text().trim();
      if (key === 'Amazon Bestsellers Rank') {
        key = 'Amazon Best Sellers Rank';
      }
      d[key] = val;
      if (key === 'Amazon Best Sellers Rank') {
        return categories = el.find('ul.zg_hrsr');
      }
    });
    asin = d['ASIN'] || d['ISBN-10'];
    rank = num(d['Amazon Best Sellers Rank']);
    tier = rank < 10 ? '1' : rank < 100 ? '2' : rank < 1000 ? 'III' : rank < 10000 ? 'IV' : rank < 100000 ? 'V' : 'VI';
    author = $('.author .contributorNameID').clone().attr({
      target: '_blank'
    });
    if (!author.length) {
      author = $('.author .a-link-normal').clone().attr({
        target: '_blank'
      });
    }
    ratingAvg = num($('#summaryStars a.product-reviews-link').attr('title') || $('#revFMSR a').attr('title'));
    ratingCount = num($('#acrCustomerReviewText').text() || $('#revSAFRLU').text());
    publisher = d['Publisher'] ? d['Publisher'].replace(/;.*/, '') : d['Sold by'];
    pubDateRaw = d['Publication Date'] || d['Publisher'].match(/\((.*)\)/)[1];
    pubDate = moment(pubDateRaw, 'MMMM D, YYYY');
    age = moment.duration(moment().diff(pubDate));
    length = d['Print Length'] || d['Paperback'] || d['Hardcover'];
    words = length ? num(length) * 225 : 0;
    fileSize = d['File Size'];
    info = $('<div id="amazon-product-info-ext"/>');
    info.appendTo('header');
    info.append([
      "<b>" + ($('#title').text()) + "</b>", '<br/>', 'Publisher: ', (function() {
        if (/Amazon\s+Digital\s+Services\s+LLC/.test(publisher)) {
          return '<span class=hi>Self-Published</span>';
        } else {
          return publisher;
        }
      })(), ' - ', 'Author: ', $('<span class=authors/>').append(author), length ? (" - Length: " + length + " (~" + (words.toLocaleString()) + " words)") + '<sup><abbr title="Number of pages times 225 words per page">?</abbr></sup>' : void 0, fileSize ? " - Size: " + fileSize : void 0, '<br/>', 'Rank: #', rank.toLocaleString(), ' - ', 'Tier ', tier, '<sup><abbr title="From Chris Fox\'s &quot;Writing To Market&quot;">?</abbr></sup>', ' - ', "<a href='https://www.novelrank.com/asin/" + asin + "'>NovelRank</a>", ' - ', 'Rating: ', ratingAvg, ' - ', 'Reviews: ', "<a href=#customerReviews>" + (ratingCount.toLocaleString()) + "</a>", ' - ', 'Age: ', (Math.round(age.asWeeks())) + " weeks", ' - ', 'Ratio: ', Number(ratingCount / age.asWeeks()).toFixed(2), '<sup><abbr title="Number of ratings divided by the age in weeks">?</abbr></sup>', '<br/>', categories
    ]);
    close = $('<div/>');
    close.css({
      position: 'absolute',
      top: '10px',
      right: '10px'
    });
    close.appendTo(info);
    removeBtn = $('<a href="#">X</a>');
    removeBtn.css({
      textDecoration: 'none'
    });
    removeBtn.on('click', function(e) {
      info.hide();
      return e.preventDefault();
    });
    return removeBtn.appendTo(close);
  });

}).call(this);
