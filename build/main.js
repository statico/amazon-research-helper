// Generated by CoffeeScript 1.12.2
(function() {
  var $;

  $ = jQuery.noConflict();

  $(function() {
    var age, asin, author, categories, close, details, fileSize, info, length, pubDate, pubDateRaw, publisher, rank, ratingAvg, ratingCount, rawRank, ref, ref1, removeBtn, tier, words;
    if (!/Amazon Best Sellers Rank/.test($('body').text())) {
      return;
    }
    details = {};
    categories = $();
    $('#productDetailsTable .content > ul > li').each(function() {
      var el, key, val;
      key = $(this).find('b:eq(0)').text().replace(/:$/, '').trim();
      el = $(this).clone();
      el.find('b:eq(0)').remove();
      val = el.text().trim();
      details[key] = val;
      if (key = 'Amazon Best Sellers Rank') {
        return categories = el.find('ul.zg_hrsr');
      }
    });
    asin = details['ASIN'] || details['ISBN-10'];
    rawRank = details['Amazon Best Sellers Rank'].match(/(#[\d,]+)/)[1];
    rank = Number(rawRank != null ? rawRank.replace(/[,#]/g, '') : void 0);
    tier = rank < 10 ? '1' : rank < 100 ? '2' : rank < 1000 ? 'III' : rank < 10000 ? 'IV' : rank < 100000 ? 'V' : 'VI';
    author = $('.author .contributorNameID').clone().attr({
      target: '_blank'
    });
    if (!author.length) {
      author = $('.author .a-link-normal').clone().attr({
        target: '_blank'
      });
    }
    ratingAvg = Number((ref = $('#summaryStars a.product-reviews-link').attr('title')) != null ? ref.match(/([\d\.]+)/)[1] : void 0);
    ratingCount = Number((ref1 = $('#acrCustomerReviewText').text().match(/([\d\.]+)/)) != null ? ref1[1] : void 0);
    publisher = details['Publisher'] ? details['Publisher'].replace(/;.*/, '') : details['Sold by'];
    pubDateRaw = details['Publication Date'] || details['Publisher'].match(/\((.*)\)/)[1];
    pubDate = moment(pubDateRaw, 'MMMM D, YYYY');
    age = moment.duration(moment().diff(pubDate));
    length = details['Print Length'] || details['Paperback'] || details['Hardcover'];
    words = length ? Number(length.match(/(\d+)/)[1]) * 255 : 0;
    fileSize = details['File Size'];
    info = $('<div id="amazon-product-info-ext"/>');
    info.appendTo('header');
    info.append([
      "<b>" + ($('#title').text()) + "</b>", '<br/>', 'Publisher: ', (function() {
        if (/Amazon\s+Digital\s+Services\s+LLC/.test(publisher)) {
          return '<span class=hi>Self-Published</span>';
        } else {
          return publisher;
        }
      })(), ' - ', 'Author: ', $('<span class=authors/>').append(author), length ? " - Length: " + length + " (~" + words + " words)" : void 0, fileSize ? " - Size: " + fileSize : void 0, '<br/>', 'Rank: ', rawRank, ' - ', 'Tier ', tier, ' - ', "<a href='https://www.novelrank.com/asin/" + asin + "'>NovelRank</a>", ' - ', 'Rating: ', ratingAvg, ' - ', 'Reviews: ', "<a href=#customerReviews>" + ratingCount + "</a>", ' - ', 'Age: ', (Math.round(age.asWeeks())) + " weeks", ' - ', 'Ratio: ', Number(ratingCount / age.asWeeks()).toFixed(2), '<br/>', categories
    ]);
    close = $('<div/>');
    close.css({
      position: 'absolute',
      top: '10px',
      right: '10px'
    });
    close.appendTo(info);
    removeBtn = $('<a href="#">X</a>');
    removeBtn.css({
      textDecoration: 'none'
    });
    removeBtn.on('click', function(e) {
      info.hide();
      return e.preventDefault();
    });
    return removeBtn.appendTo(close);
  });

}).call(this);
